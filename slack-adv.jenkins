import hudson.tasks.test.AbstractTestResultAction

// def sendSlackNotification(String slackMessage) {
//   script {
//     def color = 'danger'
//     echo "[LOG] currentBuild.result: ${currentBuild.result}"
//     echo "[LOG] currentBuild.currentResult: ${currentBuild.currentResult}"

//     if (currentBuild.currentResult == 'SUCCESS') {
//       color = 'good'
//     } else if (currentBuild.currentResult == 'FAILURE') {
//       color = 'warning'
//     }

//     slackSend color: color, message: "${env.JOB_NAME} (#${env.BUILD_NUMBER}): ${slackMessage} (<${env.BUILD_URL}|Open>)"
//   }
// }

def sendSlackNotification(String slackMessage) {
  script {
    def color = 'danger'
    echo "[LOG] currentBuild.result: ${currentBuild.result}"
    echo "[LOG] currentBuild.currentResult: ${currentBuild.currentResult}"

    if (currentBuild.currentResult == 'SUCCESS') {
      color = 'good'
    } else if (currentBuild.currentResult == 'FAILURE') {
      color = 'warning'
    }

    slackSend color: color, message: "${env.JOB_NAME} (#${env.BUILD_NUMBER}): ${slackMessage} (<${env.BUILD_URL}|Open>)"
  }
}

@NonCPS
def reportTestCounts() {
  AbstractTestResultAction testResultAction =  currentBuild.rawBuild.getAction(AbstractTestResultAction.class)
  if (testResultAction != null) {
    if (testResultAction.failCount > 0) {
      sendSlackNotification "${testResultAction.failCount} test(s) failed (out of ${testResultAction.totalCount})"
    } else if (testResultAction.totalCount > 0) {
      sendSlackNotification "All tests passed (out of ${testResultAction.totalCount})"
    } else {
      sendSlackNotification "No tests were run"
    }
  }
}

pipeline {
  agent {
    label 'windows || windows-slave'
  }

  stages {

    stage ('Tests') {
      steps {
        catchError {
          // nunit testResultsPattern: 'custom_files/testResultsFailed.xml', failIfNoResults: true
          nunit testResultsPattern: 'custom_files/testResultsSuccess.xml', failIfNoResults: true
        }
        
        reportTestCounts()
      }

      // post {
      //   success {
      //     sendSlackNotification 'All tests passed.'
      //   }

      //   failure {
      //     sendSlackNotification 'Tests failed.'
      //   }

      //   aborted {
      //     sendSlackNotification 'Tests were aborted.'
      //   }
      // }
    }

  }
}